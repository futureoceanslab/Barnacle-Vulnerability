
######DATA NORMALIZATION#################################

normalize_positive <-function(x) {
  (x - min(x,na.rm = TRUE))/(max(x,na.rm = TRUE)-min(x,na.rm = TRUE))
}

normalize_negative <-function(x) {
  (max(x,na.rm = TRUE)-x)/(max(x,na.rm = TRUE)-min(x,na.rm = TRUE))
}

#1.######################ECOLOGICAL##########
### A.EXPOSURE####
####i. read cvs indicators (import database)

Boat_ecological.exposure.INDICATORS <- read.csv("data/Boat_ecological_exposure.INDICATORS.csv", sep = ";" )

####ii. use functions to normalize (Normalization positive)

exposure<- Boat_ecological.exposure.INDICATORS %>% 
  select(fishing.guild, Temp, PP)%>% 
  distinct%>%
  mutate (TempN=normalize_positive(Temp),
          PPN=normalize_positive(PP))

exposure.N<- exposure [, c(1, 4, 5)]

write.table(exposure.N, file="Boat_eco.factor_exp.csv", sep = ";" )
factor.eco.exp <- read.csv("Boat_eco.factor_exp.csv", sep = ";" )
##########Correlation plot
eco.exposure <- exposure.N [, c(2:3)]
eco.exporuse.cor <- cor(eco.exposure, use = "pairwise.complete.obs")
p1 <- corrplot(eco.exporuse.cor, order ="AOE")


### B.SENSITIVITY#####
###i. read cvs indicators (import database)

Boat_ecological.sensitivity.INDICATORS <- read.csv("data/Boat_ecological.sensitivity.INDICATORS.csv", sep = ";" )

###ii. use functions to normalize (Normalization positive)

sensitivity<- Boat_ecological.sensitivity.INDICATORS %>% 
  select(fishing.guild, ABUND, HARV, EXPLOT)%>% 
  distinct%>%
  mutate (ABUNDN=normalize_positive(ABUND),
          HARVN=normalize_positive(HARV),
          EXPLOTN=normalize_positive(EXPLOT))

sensitivity.N<- sensitivity [, c(1, 5, 6, 7)]
write.table(sensitivity.N, file="Boat_eco.factor_sen.csv", sep = ";" )
factor.eco.sen <- read.csv("Boat_eco.factor_sen.csv", sep = ";" )
######Correlation plot
eco.sensitivity <- sensitivity.N [, c(2:4)]
eco.sensitivity.cor <- cor(eco.sensitivity, use = "pairwise.complete.obs")
p2 <- corrplot(eco.sensitivity.cor, order ="AOE")


### C.RECOVERY POTENTIAL######
###i. read cvs indicators (import database)

Boat_ecological.recoverypot.INDICATORS <- read.csv("data/Boat_ecological.recoverypot.INDICATORS.csv", sep = ";" )

###ii. use functions to normalize (Normalization positive)

recovery.pot<- Boat_ecological.recoverypot.INDICATORS %>% 
  select(fishing.guild, bank.length)%>% 
  distinct%>%
  mutate (bank.lengthN=normalize_positive(bank.length))
        
recovery.potN<- recovery.pot [, c(1, 3)]
write.table(recovery.potN, file="Boat_eco.factor_reco.csv", sep = ";" )
factor.eco.reco <- read.csv("Boat_eco.factor_reco.csv", sep = ";" )

#####Correlation plot (The column "area" was eliminated and the correltion can not be done becouse there is only one variable)

#eco.recoverypot <- recovery.potN [, c(2)]
#eco.recoverypot.cor <- cor(eco.recoverypot, use = "pairwise.complete.obs")
#p3 <- corrplot(eco.recoverypot.cor, order ="AOE")

#2. #####################SOCIOECONOMIC##########
### A. SENSITIVITY####
##i. read cvs indicators (import database)

Boat_socioeco.sensitivity <- read.csv("Data/Boat_socioeco.sensitivity.csv", sep = ";" )

##ii. use functions to normalize (Normalization positive)

sensitivity.SE<- Boat_socioeco.sensitivity %>% 
  select(fishing.guild, NFISHERS, FDAYS, CATCH.V, KG.SOLD, DAYS.SOLD, POUCH, ISO, UNEMP)%>% 
  distinct%>%
  mutate (NFISHERSN=normalize_positive(NFISHERS),
          FDAYSN=normalize_positive(FDAYS),
          CATCH.VN=normalize_positive(CATCH.V),
          KG.SOLDN=normalize_positive(KG.SOLD),
          DAYS.SOLDN=normalize_positive(DAYS.SOLD),
          POUCHN=normalize_positive(POUCH),
          ISON=normalize_positive(ISO),
          UNEMPN=normalize_positive(UNEMP))

sensitivity.SE.N<- sensitivity.SE [, c(1, 10:17)]

#####Correlation plot
socioeco.sensitivity <- sensitivity.SE.N [, c(2:9)]
socioeco.sensitivity.cor <- cor(socioeco.sensitivity, use = "pairwise.complete.obs")
p5 <- corrplot(socioeco.sensitivity.cor, order ="AOE")


### B. ADAPTIVE CAPACITY####
##i. read cvs indicators (import database)

Boat.socioeco.adaptcap <- read.csv("Data/Boat.socioeco.adaptcap.csv", sep = ";" )

##ii. use functions to normalize (Normalization positive)
adapt.cap<- Boat.socioeco.adaptcap %>% 
  select(fishing.guild, GROSS.SALARY, POB.RISK, TOURIST, MARKET, ROTATION, CLOUSURE)%>% 
  distinct%>%
  mutate (GROSS.SALARYN=normalize_positive(GROSS.SALARY),
          POB.RISKN=normalize_positive(POB.RISK),
          TOURISTN=normalize_positive(TOURIST),
          MARKETN=normalize_positive(MARKET),
          ROTATION.N=normalize_positive(ROTATION),
          CLOUSURE.N=normalize_positive(CLOUSURE))

adapt.cap.N<- adapt.cap [, c(1, 8:13)]

#Correlation plot

socioeco.adaptcap <- adapt.cap.N [, c(2:7)]
socioeco.adaptcap.cor <- cor(socioeco.adaptcap, use = "pairwise.complete.obs")
p6 <- corrplot(socioeco.adaptcap.cor, order ="AOE")

####FACTORS_ECOLOGICAL#####  

#a. ecological exposure
exposure.N
factor1=transform(exposure.N,EXPOSURE= (TempN+PPN)/2) 
CLIME= factor1 [, c(1, 4)]
EXPOSURE.eco= CLIME

#b. ecological sensitivity
sensitivity.N
factor2=transform(sensitivity.N,SENSITIVITY= (ABUNDN+HARVN+EXPLOTN)/3)
factor2

SENSITIVITY.eco= factor2 [, c(1, 5)]
SENSITIVITY.eco

#c. ecological recovery potencial
recovery.potN
factor3= transform(recovery.potN, RECOVERY.POT=(bank.lengthN))
RECOVERY.POT=factor3 [, c(1, 3)]


####FACTORS_ECOLOGICAL#####  make the bar graph (error)#####

exp_factors <- EXPOSURE.eco %>% gather(FACTOR, value, -fishing.guild, factor_key=TRUE)  %>% mutate(FACTOR=gsub("\\."," ",as.character(FACTOR)))  %>% mutate(FACTOR=factor("CLIME"))

sen_factors <- SENSITIVITY.eco %>% gather(FACTOR, value, -fishing.guild, factor_key=TRUE)  %>% mutate(FACTOR=gsub("\\."," ",as.character(FACTOR)))  %>% mutate(FACTOR=factor("QUANTITY_CHANGE"))

reco_factors <- RECOVERY.POT %>% gather(FACTOR, value, -fishing.guild, factor_key=TRUE)  %>% mutate(FACTOR=gsub("\\."," ",as.character(FACTOR)))  %>% mutate(FACTOR=factor("HABITAT"))

dimension <- c("exp_factors2","sen_factors2","reco_factors2")

dimension_colors <- list(exp_factors=c("seagreen3","seagreen4"),
                         sen_factors=c("yellow3","yellow4"),
                         reco_factors=c("cornsilk3","cornsilk4"))

graphs <- dimensions  %>% lapply(function(dimension){
  # dimension <- "soc_factors" tengo que llamar una a una las bases de datos
  x<- get(dimension)
  
  s <- ggplot(data=na.omit(sen_factors), aes(x= fishing.guild , y=value, fill=FACTOR))+
    geom_bar(stat = "identity", position=position_dodge(width=0.4), width=0.3)+
    facet_grid(~FACTOR)+
    coord_flip()+
    theme_classic()+
    ylab("")+
    xlab("fishing.guild")+
    theme(axis.text.y = element_text(size=10, color="black"),
          axis.text.x = element_text(size=10,color="black",angle=50,hjust=1),
          legend.text = element_text(size=10,color = "black"),
          legend.title = element_text(size=10,color="black"),
          panel.spacing.x = unit(1,"lines"),
          strip.text = element_text(color="black",face="bold",size=11))
 s 
 
 
  if(dimension!="eco_factors"){
    
    g <- g + theme(axis.title.y = element_blank())
  }else{
    g <- g + theme(axis.title.y = element_text(size=26, color="black"))
    
  }
  g 
})

png("Figures/Fig 2 SI.png",width=25,height=12,units="in",res=300)

do.call(grid_arrange_shared_legend,c(graphs, list(nrow = 1, ncol = 3)))

dev.off()



#DIMENSION MATRIX
Dimension.matrix1<- merge(EXPOSURE.eco, SENSITIVITY.eco)
Dimension.matrix2<- merge(Dimension.matrix1, RECOVERY.POT)
write.table(Dimension.matrix2, file="Boat_ecological_dimension.matrix.csv", sep = ";" )
Ecological.dim <- read.csv("Boat_ecological_dimension.matrix.csv", sep = ";" )


#Dimension.matrix2.N<- Dimension.matrix2 %>% 
  #select(fishing.guild, EXPOSURE, SENSITIVITY, RECOVERY.POT)%>% 
  #distinct%>%
  #mutate (EXPOSUREN=normalize_positive(EXPOSURE),
          #SENSITIVITYN=normalize_positive(SENSITIVITY),
          #RECOVERY.POTN=normalize_positive(RECOVERY.POT))

#Ecological_dimension.N= Dimension.matrix2.N [, c(1, 5:7)]

#write.table(Ecological_dimension.N, file="Boat_ecological_dimension.matrix.csv", sep = ";" )
#Boat_dimension_ecological.matrix <- read.csv("Boat_ecological_dimension.matrix.csv", sep = ";" )


#ECOLOGICAL VULNERABILITY INDEX
Ecological.dim
Eco.vul= transform(Ecological.dim, ECOLOGICAL.VUL=(EXPOSURE+SENSITIVITY)-RECOVERY.POT)
ECOLOGICAL_VULNERABILITY= Eco.vul [, c(1, 5)]
write.table(ECOLOGICAL_VULNERABILITY, file="Boat_ecological_vulnerability.csv", sep = ";" )
Boat_ecological_vulnerability <- read.csv("Boat_ecological_vulnerability.csv", sep = ";" )
Boat_ecological_vulnerability

#Plot ecological vulnerability
install.packages("ggplot2")
library(ggplot2)
install.packages("tidyverse")
library(tidyverse)
library(devtools)

Boat_ecological_vulnerability %>%
  mutate(name = fct_reorder(fishing.guild, ECOLOGICAL.VUL)) %>%
  ggplot( aes(x=name, y=ECOLOGICAL.VUL)) +
  geom_bar(stat="identity") +
  coord_flip()

#NORMALIZAR ECOLOGICAL VULNERABILITY
#ECOLOGICAL_VULNERABILITY
#ECOLOGICAL_VULNERABILITY.N<- ECOLOGICAL_VULNERABILITY %>% 
  #select(fishing.guild, ECOLOGICAL.VUL)%>% 
  #distinct%>%
  #mutate (ECOLOGICAL.VULN=normalize_positive(ECOLOGICAL.VUL))

#ECOLOGICAL_VULNERABILITY.NORMALIZAD<- ECOLOGICAL_VULNERABILITY.N [, c(1, 3)]

####FACTORS_SOCIOECONOMIC####
#a.socioeco_sensitivity
Boat_ecological_vulnerability

sensitivity.SE.N

factor5=transform(sensitivity.SE.N,WORK.OPE=(NFISHERSN+FDAYSN)/2)
factor6= transform(factor5,EMPLOY.DIF= (ISON+UNEMPN)/2)
factor7=transform(factor6,PROFIT=(CATCH.VN+KG.SOLDN+DAYS.SOLDN)/3)

SENSITIVITY.factors= factor7 [, c(1, 7, 10, 11, 12)]

SENSITIVITY.factors
SENSITIVITY.1= transform(SENSITIVITY.factors, SENSITIVITY= (POUCHN+WORK.OPE+PROFIT+EMPLOY.DIF)/4)

SENSITIVITY_SOCIOECO= SENSITIVITY.1 [, c(1, 6)]
write.table(SENSITIVITY_SOCIOECO, file="Boat_socioeco_Sensitivity.csv", sep = ";" )

#b. socio_eco adaptive capacity

adapt.cap.N

factor8=transform(adapt.cap.N,ECONOMIC.STRENGTH=(GROSS.SALARYN))
factor9=transform(factor8,DEPENDENCY=(POB.RISKN+MARKETN)/2)
factor10= transform(factor9,MANAGEMENT.STRATEGIES= (ROTATION.N+CLOUSURE.N)/2)
factor11= transform(factor10,LIVELIHOOD.DIV= TOURISTN)
AC.factors= factor11 [, c(1, 8, 9, 10, 11)]

AC1= transform(AC.factors, ADAPTIVE.CAP= (ECONOMIC.STRENGTH+MANAGEMENT.STRATEGIES+LIVELIHOOD.DIV-DEPENDENCY)/4)
ADAPTIVE.CAP_SOCIOECO= AC1 [, c(1, 6)]
write.table(ADAPTIVE.CAP_SOCIOECO, file="Boat_socioeco_ADAPT.CAP.csv", sep = ";" )

Socioeconomic_dim <-merge(SENSITIVITY_SOCIOECO, ADAPTIVE.CAP_SOCIOECO)

#Socioeconomic_dim.N<- Socioeconomic_dim %>% 
  #select(fishing.guild, SENSITIVITY, ADAPTIVE.CAP)%>% 
  #distinct%>%
  #mutate (SENSITIVITYN=normalize_positive(SENSITIVITY),
          #ADAPTIVE.CAPN=normalize_positive(ADAPTIVE.CAP))

#Socioeco_dimensions_normalized= Socioeconomic_dim.N [, c(1, 4,5)]
#Socioeco_dimensions_normalized


######Socio-ecological vulnerabiliy######

final1 <- merge(Boat_ecological_vulnerability, Socioeconomic_dim)
write.table(final1, file="Boat_Socioecological_dimensions.csv", sep = ";" )
Boat_socioecological_dimensions <- read.csv("Boat_Socioecological_dimensions.csv", sep = ";" )
final1

SE.Vulnerability= transform(final1, SOCIOECOLOGICAL_VUL= (ECOLOGICAL.VUL+SENSITIVITY)-ADAPTIVE.CAP)
SOCIO_ECOLOGICAL.VULNERABILITY= SE.Vulnerability [, c(1, 5)]
write.table(SOCIO_ECOLOGICAL.VULNERABILITY, file="Boat_Socioecological_vulnerability.csv", sep = ";" )
Boat_socioecological_vunerability <- read.csv("Boat_Socioecological_vulnerability.csv", sep = ";" )


#Plot de las barras de Elena

e1 <- Boat_socioecological_dimensions %>% gather(DIMENSION, value, -fishing.guild, factor_key=TRUE)  %>% mutate(DIMENSION=gsub("\\."," ",as.character(DIMENSION)))  %>% mutate(a=factor(DIMENSION,levels = c("ECOLOGICAL_VUL","SENSITIVITY","ADAPTIVE.CAP")))

#d <- read.csv("Boat_Socioecological_dimensions2.csv", sep = ";" )
#to.plot <- d %>% mutate(Modality=toupper(Modality)) %>% complete(Modality,fishing.guild,Dimension)

d1 <- merge(e1,Boat_socioecological_vunerability)
d11<- d1 [, c(1:3, 5)]

ggplot(d11, aes(x=fishing.guild, y=value))+
  geom_bar(aes(fill = DIMENSION), stat="identity",col=NA)+
  scale_fill_manual(values=c("seagreen4","cornsilk3","yellow3"))+
  geom_point(data= d11, aes(x=fishing.guild, y= SOCIOECOLOGICAL_VUL),col="black",size=3)+
  coord_flip()+
  ylab("Socio-ecological Vulnerability")+
  theme_classic()+
  theme(legend.position = "bottom",
        strip.text = element_text(size=18,color="black",face="bold",hjust=0),
        strip.background = element_blank(),
        axis.text = element_text(size=16, color="black"),
        axis.title = element_text(size=20, color="black"),
        legend.text = element_text(size=22,color = "black"),
        legend.title = element_text(size=24,color="black"))

ggsave("Figures/Boat_dimension&sociovul.png",width = 13,height = 10,units = "in")


#PLOT

Boat_socioecological_vunerability %>%
  mutate(name = fct_reorder(fishing.guild, SOCIOECOLOGICAL_VUL)) %>%
  ggplot( aes(x=name, y=SOCIOECOLOGICAL_VUL)) +
  geom_bar(stat="identity") +
  coord_flip()

Vulnerability<- merge(Boat_socioecological_vunerability, Boat_ecological_vulnerability)
write.table(Vulnerability, file="Boat_vulnerability.csv", sep = ";" )
Boat_vulnerability<- read.csv("Boat_vulnerability.csv", sep = ";" )
Vulnerability


#PLOT GRADIENTE VULNERABILIDAD
v1<- transform(Vulnerability, Vulnerability=(SOCIOECOLOGICAL_VUL+ECOLOGICAL.VUL)/2)

ggplot(v1, aes(x=SOCIOECOLOGICAL_VUL, y=ECOLOGICAL.VUL, color=Vulnerability))+
  geom_point(size=2)+
  geom_label_repel(aes(label =fishing.guild))+
  geom_vline(xintercept = 1)+
  geom_hline(yintercept = 1)+
  scale_colour_gradient (low="green", high="red",name="Vulnerability")+
  xlab("Socio-ecological Vulnerability") +
  ylab("Ecological Vulnerability")+
  theme_classic()+
  theme(axis.text = element_text(size=14, color="black"),
        axis.title = element_text(size=16, color="black"),
        legend.text = element_text(size=12,color = "black"),
        legend.title = element_text(size=14,color="black"),
        plot.title = element_text(size=14,color="black",face="bold"),
        panel.grid.major = element_line(size=0.5,color="gray",linetype = "dotted"))


ggsave("Figures/Boat_Vulnerability.FINAL4.png",width = 10,height = 8,units = "in")

