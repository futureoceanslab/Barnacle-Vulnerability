
######DATA NORMALIZATION#################################

normalize_positive <-function(x) {
  (x - min(x,na.rm = TRUE))/(max(x,na.rm = TRUE)-min(x,na.rm = TRUE))
}

normalize_negative <-function(x) {
  (max(x,na.rm = TRUE)-x)/(max(x,na.rm = TRUE)-min(x,na.rm = TRUE))
}

#1.######################ECOLOGICAL##########
### A.EXPOSURE####
####i. read cvs indicators (import database)

Boat_ecological.exposure.INDICATORS <- read.csv("data/Boat_ecological_exposure.INDICATORS.csv", sep = ";" )

####ii. use functions to normalize (Normalization positive)

exposure<- Boat_ecological.exposure.INDICATORS %>% 
  select(fishing.guild, Temp, PP)%>% 
  distinct%>%
  mutate (TempN=normalize_positive(Temp),
          PPN=normalize_positive(PP))

exposure.N<- exposure [, c(1, 4, 5)]

##########Correlation plot
eco.exposure <- exposure.N [, c(2:3)]
eco.exporuse.cor <- cor(eco.exposure, use = "pairwise.complete.obs")
p1 <- corrplot(eco.exporuse.cor, order ="AOE")


### B.SENSITIVITY#####
###i. read cvs indicators (import database)

Boat_ecological.sensitivity.INDICATORS <- read.csv("data/Boat_ecological.sensitivity.INDICATORS.csv", sep = ";" )

###ii. use functions to normalize (Normalization positive)

sensitivity<- Boat_ecological.sensitivity.INDICATORS %>% 
  select(fishing.guild, ABUND, HARV, EXPLOT)%>% 
  distinct%>%
  mutate (ABUNDN=normalize_positive(ABUND),
          HARVN=normalize_positive(HARV),
          EXPLOTN=normalize_positive(EXPLOT))

sensitivity.N<- sensitivity [, c(1, 5, 6, 7)]

######Correlation plot
eco.sensitivity <- sensitivity.N [, c(2:4)]
eco.sensitivity.cor <- cor(eco.sensitivity, use = "pairwise.complete.obs")
p2 <- corrplot(eco.sensitivity.cor, order ="AOE")

### C.RECOVERY POTENTIAL######
###i. read cvs indicators (import database)

Boat_ecological.recoverypot.INDICATORS <- read.csv("data/Boat_ecological.recoverypot.INDICATORS.csv", sep = ";" )

###ii. use functions to normalize (Normalization positive)

recovery.pot<- Boat_ecological.recoverypot.INDICATORS %>% 
  select(fishing.guild, bank.length, bank.area)%>% 
  distinct%>%
  mutate (bank.lengthN=normalize_positive(bank.length),
          bank.areaN=normalize_positive(bank.area))
        
recovery.potN<- recovery.pot [, c(1, 4, 5)]

#####Correlation plot

eco.recoverypot <- recovery.potN [, c(2:3)]
eco.recoverypot.cor <- cor(eco.recoverypot, use = "pairwise.complete.obs")
p3 <- corrplot(eco.recoverypot.cor, order ="AOE")

#2. #####################SOCIOECONOMIC##########
### A. SENSITIVITY####
##i. read cvs indicators (import database)

Boat_socioeco.sensitivity <- read.csv("Data/Boat_socioeco.sensitivity.csv", sep = ";" )

##ii. use functions to normalize (Normalization positive)

sensitivity.SE<- Boat_socioeco.sensitivity %>% 
  select(fishing.guild, NFISHERS, FDAYS, CATCH.V, KG.SOLD, DAYS.SOLD, POUCH, ISO, UNEMP)%>% 
  distinct%>%
  mutate (NFISHERSN=normalize_positive(NFISHERS),
          FDAYSN=normalize_positive(FDAYS),
          CATCH.VN=normalize_positive(CATCH.V),
          KG.SOLDN=normalize_positive(KG.SOLD),
          DAYS.SOLDN=normalize_positive(DAYS.SOLD),
          POUCHN=normalize_positive(POUCH),
          ISON=normalize_positive(ISO),
          UNEMPN=normalize_positive(UNEMP))

sensitivity.SE.N<- sensitivity.SE [, c(1, 10:17)]

#####Correlation plot
socioeco.sensitivity <- sensitivity.SE.N [, c(2:9)]
socioeco.sensitivity.cor <- cor(socioeco.sensitivity, use = "pairwise.complete.obs")
p5 <- corrplot(socioeco.sensitivity.cor, order ="AOE")

### B. ADAPTIVE CAPACITY####
##i. read cvs indicators (import database)

Boat.socioeco.adaptcap <- read.csv("Data/Boat.socioeco.adaptcap.csv", sep = ";" )

##ii. use functions to normalize (Normalization positive)
adapt.cap<- Boat.socioeco.adaptcap %>% 
  select(fishing.guild, CPI, GROSS.SALARY, POB.RISK, TOURIST, MARKET, ROTATION, CLOUSURE)%>% 
  distinct%>%
  mutate (CPIN=normalize_positive(CPI),
          GROSS.SALARYN=normalize_positive(GROSS.SALARY),
          POB.RISKN=normalize_positive(POB.RISK),
          TOURISTN=normalize_positive(TOURIST),
          MARKETN=normalize_positive(MARKET),
          ROTATION.N=normalize_positive(ROTATION),
          CLOUSURE.N=normalize_positive(CLOUSURE))

adapt.cap.N<- adapt.cap [, c(1, 9:15)]

#Correlation plot

socioeco.adaptcap <- adapt.cap.N [, c(2:8)]
socioeco.adaptcap.cor <- cor(socioeco.adaptcap, use = "pairwise.complete.obs")
p6 <- corrplot(socioeco.adaptcap.cor, order ="AOE")

####FACTORS_ECOLOGICAL#####       
#a. ecological exposure
exposure.N
factor1=transform(exposure.N,EXPOSURE= (TempN+PPN)/2) 
CLIME= factor1 [, c(1, 4)]
EXPOSURE.eco= CLIME

#b. ecological sensitivity
sensitivity.N
factor2=transform(sensitivity.N,SENSITIVITY= (ABUNDN+HARVN+EXPLOTN)/3)
factor2

SENSITIVITY.eco= factor2 [, c(1, 5)]
SENSITIVITY.eco

#c. ecological recovery potencial
recovery.potN
factor3= transform(recovery.potN, RECOVERY.POT=(bank.lengthN+bank.areaN)/2)
RECOVERY.POT=factor3 [, c(1, 4)]

#DIMENSION MATRIX
Dimension.matrix1<- merge(EXPOSURE.eco, SENSITIVITY.eco)
Dimension.matrix2<- merge(Dimension.matrix1, RECOVERY.POT)
write.table(Dimension.matrix2, file="Boat_ecological_dimension.matrix.csv", sep = ";" )
Boat_dimension_ecological.matrix <- read.csv("Boat_ecological_dimension.matrix.csv", sep = ";" )

a<- transform(Dimension.matrix1, Ecological.impact.pot=(EXPOSURE+SENSITIVITY))
Eco.impact <- a[, c(1,4)]
b<- merge(a, RECOVERY.POT)

library(ggplot2)
ggplot(b, aes(x=RECOVERY.POT, y=Ecological.impact.pot)) +
  geom_point() 


#ECOLOGICAL VULNERABILITY INDEX
Boat_dimension_ecological.matrix
Eco.vul= transform(Boat_dimension_ecological.matrix, ECOLOGICAL.VUL=(EXPOSURE+SENSITIVITY)-RECOVERY.POT)
ECOLOGICAL_VULNERABILITY= Eco.vul [, c(1, 5)]
write.table(ECOLOGICAL_VULNERABILITY, file="Boat_ecological_vulnerability.csv", sep = ";" )
Boat_ecological_vulnerability <- read.csv("Boat_ecological_vulnerability.csv", sep = ";" )
Boat_ecological_vulnerability

#Plot ecological vulnerability
install.packages("ggplot2")
library(ggplot2)
library(tidyverse)

Boat_ecological_vulnerability %>%
  mutate(name = fct_reorder(fishing.guild, ECOLOGICAL.VUL)) %>%
  ggplot( aes(x=name, y=ECOLOGICAL.VUL)) +
  geom_bar(stat="identity") +
  coord_flip()

#NORMALIZAR ECOLOGICAL VULNERABILITY
ECOLOGICAL_VULNERABILITY
ECOLOGICAL_VULNERABILITY.N<- ECOLOGICAL_VULNERABILITY %>% 
  select(fishing.guild, ECOLOGICAL.VUL)%>% 
  distinct%>%
  mutate (ECOLOGICAL.VULN=normalize_positive(ECOLOGICAL.VUL))

ECOLOGICAL_VULNERABILITY.NORMALIZAD<- ECOLOGICAL_VULNERABILITY.N [, c(1, 3)]

####FACTORS_SOCIOECONOMIC####
#a.socioeco_sensitivity

sensitivity.SE.N

factor5=transform(sensitivity.SE.N,WORK.OPE=(NFISHERSN+FDAYSN)/2)
factor6= transform(factor5,EMPLOY.DIF= (ISON+UNEMPN)/2)
factor7=transform(factor6,PROFIT=(CATCH.VN+KG.SOLDN+DAYS.SOLDN)/3)

SENSITIVITY.factors= factor7 [, c(1, 7, 10, 11, 12)]

SENSITIVITY.factors
SENSITIVITY.1= transform(SENSITIVITY.factors, SENSITIVITY= (POUCHN+WORK.OPE+PROFIT+EMPLOY.DIF)/4)
write.table(SENSITIVITY.1, file="changeNAPouch.csv", sep = ";" )

sen2=transform(SENSITIVITY.1, sens.napouch=(WORK.OPE+PROFIT+EMPLOY.DIF)/3) #Calculo el valor sin el NA
Aguino= sen2 [8, c(1,7)]
PortodoSon= sen2 [21, c(1,7)]

SENSITIVITY.socioeco <- read.csv("changeNAPouch.csv", sep = ";" ) #los introduzco manualmente en la database.
SENSITIVITY_SOCIOECO= SENSITIVITY.socioeco [, c(1, 6)]
write.table(SENSITIVITY_SOCIOECO, file="Boat_socioeco_Sensitivity.csv", sep = ";" )

#b. socio_eco adaptive capacity

adapt.cap.N

factor8=transform(adapt.cap.N,ECONOMIC.STRENGTH=(GROSS.SALARYN- CPIN)/2)
factor9=transform(factor8,DEPENDENCY=(POB.RISKN+MARKETN)/2)
factor10= transform(factor9,MANAGEMENT.STRATEGIES= (ROTATION.N+CLOUSURE.N)/2)
factor11= transform(factor10,LIVELIHOOD.DIV= TOURISTN)
AC.factors= factor11 [, c(1, 9, 10, 11, 12)]

AC1= transform(AC.factors, ADAPTIVE.CAP= (ECONOMIC.STRENGTH+MANAGEMENT.STRATEGIES+LIVELIHOOD.DIV-DEPENDENCY)/4)
ADAPTIVE.CAP_SOCIOECO= AC1 [, c(1, 6)]
write.table(ADAPTIVE.CAP_SOCIOECO, file="Boat_socioeco_ADAPT.CAP.csv", sep = ";" )

Socioeconomic_dim <-merge(SENSITIVITY_SOCIOECO, ADAPTIVE.CAP_SOCIOECO)

Socioeconomic_dim.N<- Socioeconomic_dim %>% 
  select(fishing.guild, SENSITIVITY, ADAPTIVE.CAP)%>% 
  distinct%>%
  mutate (SENSITIVITYN=normalize_positive(SENSITIVITY),
          ADAPTIVE.CAPN=normalize_positive(ADAPTIVE.CAP))

Socioeco_dimensions_normalized= Socioeconomic_dim.N [, c(1, 4,5)]
Socioeco_dimensions_normalized


######Socio-ecological vulnerabiliy######

final1 <- merge(ECOLOGICAL_VULNERABILITY.NORMALIZAD, Socioeco_dimensions_normalized)
write.table(final1, file="Boat_Socioecological_dimensions.csv", sep = ";" )
Boat_socioecological_dimensions <- read.csv("Boat_Socioecological_dimensions.csv", sep = ";" )
final1

SE.Vulnerability= transform(final1, SOCIOECOLOGICAL_VUL= (ECOLOGICAL.VULN+SENSITIVITYN)-ADAPTIVE.CAPN)
SOCIO_ECOLOGICAL.VULNERABILITY= SE.Vulnerability [, c(1, 5)]
write.table(SOCIO_ECOLOGICAL.VULNERABILITY, file="Boat_Socioecological_vulnerability.csv", sep = ";" )
Boat_socioecological_vunerability <- read.csv("Boat_Socioecological_vulnerability.csv", sep = ";" )


#PLOT

Boat_socioecological_vunerability %>%
  mutate(name = fct_reorder(fishing.guild, SOCIOECOLOGICAL_VUL)) %>%
  ggplot( aes(x=name, y=SOCIOECOLOGICAL_VUL)) +
  geom_bar(stat="identity") +
  coord_flip()

Vulnerability<- merge(Boat_socioecological_vunerability, Boat_ecological_vulnerability)
Vulnerability

ggplot(Vulnerability, aes(x=SOCIOECOLOGICAL_VUL, y=ECOLOGICAL.VUL, color=fishing.guild)) +
  geom_point(alpha=1)

