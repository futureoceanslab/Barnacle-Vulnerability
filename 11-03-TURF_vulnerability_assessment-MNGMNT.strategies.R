

#libraries
library(ggrepel)
library(readr)
library(tidyverse)
library(corrplot)
library(ggplot2)
library(dplyr)
library(tidyr)


######DATA NORMALIZATION#################################

normalize_positive <-function(x) {
  (x - min(x,na.rm = TRUE))/(max(x,na.rm = TRUE)-min(x,na.rm = TRUE))
}

normalize_negative <-function(x) {
  (max(x,na.rm = TRUE)-x)/(max(x,na.rm = TRUE)-min(x,na.rm = TRUE))
}

#1.######################ECOLOGICAL##########
### A.EXPOSURE####
####i. read cvs indicators (import database)

Ecological_exposure <- read.csv("data/Ecological_exposure.csv", sep = ";" )

####ii. use functions to normalize (Normalization positive)

exposure<- Ecological_exposure %>% 
  select(fishing.guild, Text)%>% 
  distinct%>%
  mutate (TextN=normalize_positive(Text))

exposure.N<- exposure [, c(1, 3)]

write.table(exposure.N, file="generated_dataframes/eco.factor_exp.csv", sep = ";" )
factor.eco.exp <- read.csv("generated_dataframes/eco.factor_exp.csv", sep = ";" )

##########Correlation plot
#eco.exposure <- exposure.N [, c(2:4)]
#eco.exporuse.cor <- cor(eco.exposure, use = "pairwise.complete.obs")
#p1 <- corrplot(eco.exporuse.cor, order ="AOE")

### B.SENSITIVITY#####
###i. read cvs indicators (import database)

Ecological_sensitivity <- read.csv("data/Ecological_sensitivity.csv", sep = ";" )

###ii. use functions to normalize (Normalization positive)

sensitivity<- Ecological_sensitivity %>% 
  select(fishing.guild, ABUND, HARV, EXPLOT)%>% 
  distinct%>%
  mutate (ABUNDN=normalize_positive(ABUND),
          HARVN=normalize_positive(HARV),
          EXPLOTN=normalize_positive(EXPLOT))

sensitivity.N<- sensitivity [, c(1, 5, 6, 7)]
write.table(sensitivity.N, file="generated_dataframes/Boat_eco.factor_sen.csv", sep = ";" )
factor.eco.sen <- read.csv("generated_dataframes/Boat_eco.factor_sen.csv", sep = ";" )
######Correlation plot
#eco.sensitivity <- sensitivity.N [, c(2:4)]
#eco.sensitivity.cor <- cor(eco.sensitivity, use = "pairwise.complete.obs")
#p2 <- corrplot(eco.sensitivity.cor, order ="AOE")


### C.RECOVERY POTENTIAL######
###i. read cvs indicators (import database)

Ecological_recoverypot <- read.csv("data/Ecological_recoverypot.csv", sep = ";" )

###ii. use functions to normalize (Normalization positive)

recovery.pot<- Ecological_recoverypot %>% 
  select(fishing.guild, bank.length)%>% 
  distinct%>%
  mutate (bank.lengthN=normalize_positive(bank.length))
        
recovery.potN<- recovery.pot [, c(1, 3)]
write.table(recovery.potN, file="generated_dataframes/Boat_eco.factor_reco.csv", sep = ";" )
factor.eco.reco <- read.csv("generated_dataframes/Boat_eco.factor_reco.csv", sep = ";" )



f<- merge(factor.eco.reco, factor.eco.sen)
f2<- merge(f, factor.eco.exp)
f3<-  f2 [, c(2:6)]
finalcor<- cor(f3, use = "pairwise.complete.obs")
fplot <- corrplot(finalcor, order ="AOE")
ggsave("figures/ecological_correlation.png",width = 10,height = 8,units = "in")

#open the pdf device
pdf(file="figures/Ecological_correlation_plot.pdf", height=5, width=1.6*5)
#fill the pdf
finalcor<- cor(f3, use = "pairwise.complete.obs")
fplot <- corrplot(finalcor, order ="AOE")
#close the pdf
dev.off()



#2. #####################SOCIOECONOMIC##########
### A. SENSITIVITY####
##i. read cvs indicators (import database)

Socioeco_sensitivity <- read.csv("Data/Socioeco_sensitivity.csv", sep = ";" )

##ii. use functions to normalize (Normalization positive)

sensitivity.SE<- Socioeco_sensitivity %>% 
  select(fishing.guild, FISHERY.DEPENDENCY, Relative_fishers, fishing.effort, POUCH, ISO, Modality)%>% 
  distinct%>%
  mutate (Relative_fishersN=normalize_positive(Relative_fishers),
          FISHERY.DEPENDENCYN=normalize_positive(FISHERY.DEPENDENCY),
          fishing.effortN=normalize_positive(fishing.effort),
          POUCHN=normalize_positive(POUCH),
          ISON=normalize_positive(ISO),
          Modality=Modality)

sensitivity.SE.N<- sensitivity.SE [, c(1, 7:12)]

#####Correlation plot
#socioeco.sensitivity <- sensitivity.SE.N [, c(2:6)]
#socioeco.sensitivity.cor <- cor(socioeco.sensitivity, use = "pairwise.complete.obs")
#p5 <- corrplot(socioeco.sensitivity.cor, order ="AOE")


### B. ADAPTIVE CAPACITY####
##i. read cvs indicators (import database)

Socioeco_adaptivecap <- read.csv("Data/Socioeco_adaptivecap.csv", sep = ";" )

##ii. use functions to normalize (Normalization positive)
adapt.cap<- Socioeco_adaptivecap %>% 
  select(fishing.guild, GROSS.SALARY, FISHERS.WELL, MARKET, ROTATION, CLOUSURE, ADAPT.MNGMT)%>% 
  distinct%>%
  mutate (FISHERS.WELLN=normalize_positive(FISHERS.WELL),
          MARKETN=normalize_positive(MARKET),
          ROTATION.N=normalize_positive(ROTATION),
          CLOUSURE.N=normalize_positive(CLOUSURE),
          ADAPT.MNGMT.N=normalize_positive(ADAPT.MNGMT))

adapt.cap.N<- adapt.cap [, c(1, 8:12)]

#Correlation plot

socioeco.adaptcap <- adapt.cap.N [, c(2:6)]
socioeco.adaptcap.cor <- cor(socioeco.adaptcap, use = "pairwise.complete.obs")
p6 <- corrplot(socioeco.adaptcap.cor, order ="AOE")

f4<- merge(adapt.cap.N, sensitivity.SE.N)
f5<- merge(f4, f2)
f6<-  f5 [, c(2:5, 8:17)]
fin_cor<- cor(f6, use = "pairwise.complete.obs")
fplot2 <- corrplot(fin_cor, order ="AOE")
ggsave("figures/final_correlation.png",width = 10,height = 8,units = "in")

#open the pdf device
pdf(file="figures/correlation_plot.pdf", height=5, width=1.6*5)
#fill the pdf
fin_cor<- cor(f6, use = "pairwise.complete.obs")
fplot2 <- corrplot(fin_cor, order ="AOE")
#close the pdf
dev.off()


f7<- f4 [, c(2:5, 8:12)]
socio_cor1<- cor(f7, use = "pairwise.complete.obs")
fplot3 <- corrplot(socio_cor1, order ="AOE")
ggsave("../figures/final_correlation.png",width = 10,height = 8,units = "in")

#open the pdf device
pdf(file="figures/Socio_correlation_plot.pdf", height=5, width=1.6*5)
#fill the pdf
socio_cor1<- cor(f7, use = "pairwise.complete.obs")
fplot3 <- corrplot(socio_cor1, order ="AOE")
#close the pdf
dev.off()


####FACTORS_ECOLOGICAL#####  

#a. ecological exposure
exposure.N
factor1=transform(exposure.N,CLIME= TextN)
EXPOSURE.eco= factor1 [, c(1, 3)]
expo=transform(EXPOSURE.eco, EXPOSURE= CLIME)
EXPOSURE= expo[, c(1,3)]

#b. ecological sensitivity
sensitivity.N
factor2=transform(sensitivity.N,QUANTITY_CHANGE= (ABUNDN+HARVN+EXPLOTN)/3)
factor2
SENSITIVITY.eco= factor2 [, c(1, 5)]
sens=transform(SENSITIVITY.eco, SENSITIVITY= QUANTITY_CHANGE)
SENSITIVITY= sens [, c(1,3)]


#c. ecological recovery potencial
recovery.potN
factor3= transform(recovery.potN, HABITAT=(bank.lengthN))
RECOVERY.POT=factor3 [, c(1, 3)]
RECOVERY.POTENL= transform(RECOVERY.POT, RECOVERY.POT=(HABITAT))
RECOVERY.POTENCIAL=RECOVERY.POTENL [, c(1, 3)]


#DIMENSION MATRIX
Dimension.matrix1<- merge(EXPOSURE, SENSITIVITY)
Dimension.matrix2<- merge(Dimension.matrix1, RECOVERY.POTENCIAL)
write.table(Dimension.matrix2, file="generated_dataframes/Ecological_dimension.matrix.csv", sep = ";" )
Ecological.dim <- read.csv("generated_dataframes/Ecological_dimension.matrix.csv", sep = ";" )
Ecological.dim

#ECOLOGICAL VULNERABILITY SCORE
Eco.vul= transform(Ecological.dim, ECOLOGICAL.VUL=(EXPOSURE+SENSITIVITY)-RECOVERY.POT)
write.table(Eco.vul, file="generated_dataframes/Ecological_vulnerability2.csv", sep = ";" )


ECOLOGICAL_VULNERABILITY= Eco.vul [, c(1, 5)]
write.table(ECOLOGICAL_VULNERABILITY, file="generated_dataframes/Ecological_vulnerability.csv", sep = ";" )
ecological_vulnerability <- read.csv("generated_dataframes/Ecological_vulnerability.csv", sep = ";" )
ecological_vulnerability

ecological_vulnerability %>%
  mutate(name = fct_reorder(fishing.guild, ECOLOGICAL.VUL)) %>%
  ggplot( aes(x=name, y=ECOLOGICAL.VUL)) +
  geom_bar(stat="identity") +
  coord_flip()

#open the pdf device
pdf(file="figures/Ecological_vulnerability_plot.pdf", height=5, width=1.6*5)
#fill the pdf
ecological_vulnerability %>%
  mutate(name = fct_reorder(fishing.guild, ECOLOGICAL.VUL)) %>%
  ggplot( aes(x=name, y=ECOLOGICAL.VUL)) +
  geom_bar(stat="identity") +
  coord_flip()
#close the pdf
dev.off()


####FACTORS_SOCIOECONOMIC####
#a.socioeco_sensitivity
sensitivity.SE.N

factor5=transform(sensitivity.SE.N, WORK_OPE= (fishing.effortN+Relative_fishersN)/2)
factor6= transform(factor5, EMPLOY_DIF= ISON)
factor7=transform(factor6, POUCH= POUCHN)
factor8=transform(factor7, FISHING_DEPENDENCY= FISHERY.DEPENDENCYN)
factor9=transform(factor8, Modality= Modality)


SENSITIVITY.factors= factor9 [, c(1:2, 8:11)]

SENSITIVITY.factors
SENSITIVITY.1= transform(SENSITIVITY.factors, SENSITIVITY= (POUCH+FISHING_DEPENDENCY+WORK_OPE+EMPLOY_DIF)/4)

SENSITIVITY_SOCIOECO= SENSITIVITY.1 [, c(1, 7)]
write.table(SENSITIVITY.1, file="generated_dataframes/Socioeco_Sensitivity.csv", sep = ";" )
socioeco.sen_factors <- read.csv("generated_dataframes/Socioeco_Sensitivity.csv", sep = ";" )

#b. socio_eco adaptive capacity

adapt.cap.N

factor10= transform(adapt.cap.N,MANAGEMENT_STRATEGIES= (ROTATION.N+CLOUSURE.N)/2)

AC.factors= factor10 [, c(1,2,3,6,7)]
AC.factors

write.table(AC.factors, file="generated_dataframes/Socioeco_adapt.csv", sep = ";" )
socioeco.adapt_factors <- read.csv("generated_dataframes/Socioeco_adapt.csv", sep = ";" )

AC1= transform(AC.factors, ADAPTIVE.CAP= (FISHERS.WELLN+ADAPT.MNGMT.N+MARKETN)/3)
ADAPTIVE.CAP_SOCIOECO= AC1 [, c(1, 6)]
write.table(ADAPTIVE.CAP_SOCIOECO, file="generated_dataframes/Socioeco_ADAPT.CAP.csv", sep = ";" )

Socioeconomic_dim <-merge(SENSITIVITY_SOCIOECO, ADAPTIVE.CAP_SOCIOECO)
Socio_ecological_dimension <- merge( Socioeconomic_dim, ECOLOGICAL_VULNERABILITY)
Socio_ecological_dimension
write.table(Socio_ecological_dimension, file="generated_dataframes/Socio_ecological_dimension.csv", sep = ";" )


#Socioeconomic_dim.N<- Socio_ecological_dimension %>% 
  #select(fishing.guild, ECOLOGICAL.VUL, SENSITIVITY, ADAPTIVE.CAP)%>% 
  #distinct%>%
  #mutate (ECOLOGICAL.VULN=normalize_positive(ECOLOGICAL.VUL))

#Socioeconomic_dim.N
#Socioeco_dimensions_normalized= Socioeconomic_dim.N [, c(1, 3, 4, 5)]
#Socioeco_dimensions_normalized

#write.table(Socio_ecological_dimension, file="Socio_ecological_dimensions.csv", sep = ";" )
Socio_ecological_dimensions<- read.csv("generated_dataframes/Socio_ecological_dimension.csv", sep = ";" )
Socio_ecological_dimensions

Socio_ecological_dimensions_GOOD<- transform(Socio_ecological_dimensions, ADAPTIVE.CAP= -ADAPTIVE.CAP)


######Socio-ecological vulnerability######

SE.Vulnerability= transform(Socio_ecological_dimensions_GOOD, SOCIOECOLOGICAL_VUL= (ECOLOGICAL.VUL+SENSITIVITY)--ADAPTIVE.CAP)
write.table(SE.Vulnerability, file="generated_dataframes/Socioecological_vulnerabilityanddim.csv", sep = ";" )

SOCIO_ECOLOGICAL.VULNERABILITY= SE.Vulnerability [, c(1, 5)]
write.table(SOCIO_ECOLOGICAL.VULNERABILITY, file="generated_dataframes/Socioecological_vulnerability.csv", sep = ";" )
socioecological_vunerability <- read.csv("generated_dataframes/Socioecological_vulnerability.csv", sep = ";" )
socioecological_vunerability

#Plot de las barras de Elena

e1 <- Socio_ecological_dimensions_GOOD %>% gather(DIMENSION, value, -fishing.guild, factor_key=TRUE)  %>% mutate(DIMENSION=gsub("\\."," ",as.character(DIMENSION)))  %>% mutate(a=factor(DIMENSION,levels = c("ECOLOGICAL_VUL","SENSITIVITY","ADAPTIVE.CAP")))

#d <- read.csv("Boat_Socioecological_dimensions2.csv", sep = ";" )
#to.plot <- d %>% mutate(Modality=toupper(Modality)) %>% complete(Modality,fishing.guild,Dimension)

d1 <- merge(e1,socioecological_vunerability)
d11<- d1 [, c(1:3, 5)]

pdf(file="figures/Socioecological_vulnerability_barplot_2MNGMT.pdf", height=8, width=1.6*9)
ggplot(d11, aes(x=fishing.guild, y=value))+
  geom_bar(aes(fill = DIMENSION), stat="identity",col=NA)+
  scale_fill_manual(values=c("seagreen4","yellow3", "cornsilk3"))+
  geom_point(data= d11, aes(x=fishing.guild, y= SOCIOECOLOGICAL_VUL),col="black",size=3)+
  coord_flip()+
  ylab("Socio-ecological Vulnerability")+
  theme_classic()+
  theme(legend.position = "bottom",
        strip.text = element_text(size=18,color="black",face="bold",hjust=0),
        strip.background = element_blank(),
        axis.text = element_text(size=16, color="black"),
        axis.title = element_text(size=20, color="black"),
        legend.text = element_text(size=22,color = "black"),
        legend.title = element_text(size=24,color="black"))
dev.off()


#PLOT

socioecological_vunerability %>%
  mutate(name = fct_reorder(fishing.guild, SOCIOECOLOGICAL_VUL)) %>%
  ggplot( aes(x=name, y=SOCIOECOLOGICAL_VUL)) +
  geom_bar(stat="identity") +
  coord_flip()

ggsave("Figures/guilds_vulnerability.png",width = 13,height = 10,units = "in")

Vulnerability<- merge(socioecological_vunerability, ecological_vulnerability)
write.table(Vulnerability, file="Vulnerability.csv", sep = ";" )
vulnerability_fin<- read.csv("Vulnerability.csv", sep = ";" )
vulnerability_fin


#PLOT GRADIENTE VULNERABILIDAD
V<- merge(socioeco.adapt_factors, socioeco.sen_factors)
V0<- V [, c(1,5,6)]
V1<- merge(V0, vulnerability_fin)
v1<- transform(Vulnerability, Vulnerability=(SOCIOECOLOGICAL_VUL+ECOLOGICAL.VUL)/2)

#VULNERABILITY BY MODALITY
pdf(file="figures/Socioecological_vulnerability_bymodality_2MNGMT.pdf", height=8, width=6)
ggplot(V1, aes(x=SOCIOECOLOGICAL_VUL, y=ECOLOGICAL.VUL, color=Modality))+
  geom_point(size=2)+
  geom_label_repel(aes(label =fishing.guild))+
  geom_vline(xintercept = 1)+
  geom_hline(yintercept = 1)+
  xlab("Socio-ecological Vulnerability") +
  ylab("Ecological Vulnerability")+
  theme_classic()+
  theme(axis.text = element_text(size=14, color="black"),
        axis.title = element_text(size=16, color="black"),
        legend.text = element_text(size=12,color = "black"),
        legend.title = element_text(size=14,color="black"),
        plot.title = element_text(size=14,color="black",face="bold"),
        panel.grid.major = element_line(size=0.5,color="gray",linetype = "dotted"))
 dev.off()

 
 #VULNERABILITY BY MANAGEMENT STRATEGIES
 pdf(file="figures/Socioecological_vulnerability_2MNGMNT.pdf", height=8, width=6)
 ggplot(V1, aes(x=SOCIOECOLOGICAL_VUL, y=ECOLOGICAL.VUL, color=MANAGEMENT_STRATEGIES))+
   geom_point(size=2)+
   geom_label_repel(aes(label =fishing.guild))+
   geom_vline(xintercept = 1)+
   geom_hline(yintercept = 1)+
   scale_colour_gradient (low="red", high="green",name="MNGMNT_STRATEGIES")+
   xlab("Socio-ecological Vulnerability") +
   ylab("Ecological Vulnerability")+
   theme_classic()+
   theme(axis.text = element_text(size=14, color="black"),
         axis.title = element_text(size=16, color="black"),
         legend.text = element_text(size=12,color = "black"),
         legend.title = element_text(size=14,color="black"),
         plot.title = element_text(size=14,color="black",face="bold"),
         panel.grid.major = element_line(size=0.5,color="gray",linetype = "dotted"))
 dev.off()
 


#label plot by management strategies
 
union1<- merge(Socio_ecological_dimension, AC.factors)
reves.adapcap<- transform(union1, ADAP.CAP=rev(ADAPTIVE.CAP))
aa<- merge(V1, union1)

pdf(file="figures/Sociocial_vulnerability_labelplot_mngmnt-strategies.pdf", height=8, width=7)
ggplot(aa, aes(x=ADAPTIVE.CAP, y=SENSITIVITY, color=ECOLOGICAL.VUL, size= MANAGEMENT_STRATEGIES))+
  geom_point(alpha=0.2)+
  scale_size_continuous(name="MNGMNT_STRATEGIES", limits=range(0, 1))+
  scale_colour_gradient (low="green", high="red",name="Exposure")+
  geom_label_repel(aes(label =fishing.guild))+
  xlab("Adaptive Capacity") +
  xlim(1, 0)+
  ylab("Sensitivity")+
  theme_classic()+
  theme(axis.text = element_text(size=14, color="black"),
        axis.title = element_text(size=16, color="black"),
        legend.text = element_text(size=12,color = "black"),
        legend.title = element_text(size=14,color="black"),
        plot.title = element_text(size=14,color="black",face="bold"),
        panel.grid.major = element_line(size=0.5,color="gray",linetype = "dotted"))

dev.off()


pdf(file="figures/Sociocial_vulnerability_labelplot_modalities.pdf", height=8, width=7)
ggplot(aa, aes(x=ADAPTIVE.CAP, y=SENSITIVITY, color=ECOLOGICAL.VUL, shape= Modality))+
  geom_point()+
  scale_size_continuous(name="MNGMNT_STRATEGIES", limits=range(0, 1))+
  scale_colour_gradient (low="green", high="red",name="Exposure")+
  geom_label_repel(aes(label =fishing.guild))+
  xlab("Adaptive Capacity") +
  scale_shape(solid = TRUE)+
  xlim(1, 0)+
  ylab("Sensitivity")+
  theme_classic()+
  theme(axis.text = element_text(size=14, color="black"),
        axis.title = element_text(size=16, color="black"),
        legend.text = element_text(size=12,color = "black"),
        legend.title = element_text(size=14,color="black"),
        plot.title = element_text(size=14,color="black",face="bold"),
        panel.grid.major = element_line(size=0.5,color="gray",linetype = "dotted"))

dev.off()


  #bubble plot without label 
ggplot(Socio_ecological_dimension, aes(x=ADAPTIVE.CAP, y=SENSITIVITY, size=ECOLOGICAL.VUL, color=fishing.guild))+
    geom_point(alpha=1)+
    scale_size_continuous(range = c(0.5, 8))+
    xlim(1, 0)+
    ylim(0, 1)+
    xlab("Adaptive Capacity")+
    ylab("Sensitivity")+
    theme_classic()+
    theme(axis.text = element_text(size=14, color="black"),
          axis.title = element_text(size=16, color="black"),
          legend.text = element_text(size=12,color = "black"),
          legend.title = element_text(size=14,color="black"),
          plot.title = element_text(size=14,color="black",face="bold"),
          panel.grid.major = element_line(size=0.5,color="gray",linetype = "dotted"))
  
  
#Socio-ecological dimesion bubble plot with label but whitout colour
  pdf(file="figures/Sociocial_vulnerability_bubbleplot.pdf", height=8, width=7)
  ggplot(Socio_ecological_dimension, aes(x=ADAPTIVE.CAP, y=SENSITIVITY, size=ECOLOGICAL.VUL))+
    geom_point(alpha=0.5)+
    scale_size_continuous(name="EXPOSURE", range = c(2, 8))+
    geom_label_repel(aes(label =fishing.guild))+
    xlim(1, 0)+
    ylim(0, 1)+
    xlab("Adaptive Capacity")+
    ylab("Sensitivity")+
    theme_classic()+
    theme(axis.text = element_text(size=14, color="black"),
          axis.title = element_text(size=16, color="black"),
          legend.text = element_text(size=12,color = "black"),
          legend.title = element_text(size=14,color="black"),
          plot.title = element_text(size=14,color="black",face="bold"),
          panel.grid.major = element_line(size=0.5,color="gray",linetype = "dotted"))
  dev.off()

  ggsave("figures/bubbleplot.png",width = 10,height = 8,units = "in")
  
  #Ecological dimesion bubble plot with label but whitout colour
  pdf(file="figures/ecological_vulnerability_bubbleplot.pdf", height=8, width=7)
  ggplot(Ecological.dim, aes(x=RECOVERY.POT, y=SENSITIVITY, size=EXPOSURE))+
    geom_point(alpha=0.5)+
    scale_size_continuous(range = c(2, 8))+
    geom_label_repel(aes(label =fishing.guild))+
    xlim(1, 0)+
    ylim(0, 1)+
    xlab("Recovery potential")+
    ylab("Sensitivity")+
    theme_classic()+
    theme(axis.text = element_text(size=14, color="black"),
          axis.title = element_text(size=16, color="black"),
          legend.text = element_text(size=12,color = "black"),
          legend.title = element_text(size=14,color="black"),
          plot.title = element_text(size=14,color="black",face="bold"),
          panel.grid.major = element_line(size=0.5,color="gray",linetype = "dotted"))
  dev.off()
  
  ggsave("figures/bubbleplot_ecological.png",width = 10,height = 8,units = "in")
  